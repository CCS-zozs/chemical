<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>ç°åˆ©æµ¦å®¶çš„å…¬ç§¯é‡‘è´·æ¬¾è®¡ç®—å™¨ - æ”¯æŒæå‰è¿˜æ¬¾è®¡ç®—</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        margin: 20px;
        background-color: #f4f7f9;
        color: #333;
      }
      .container {
        max-width: 600px;
        margin: auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      h1,
      h2 {
        text-align: center;
        color: #0056b3;
      }
      .form-group {
        margin-bottom: 18px;
      }
      label {
        display: block;
        margin-bottom: 6px;
        font-weight: bold;
      }
      input[type="number"],
      select {
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1em;
      }
      button {
        width: 100%;
        padding: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 4px;
        font-size: 1.1em;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #0056b3;
      }
      #results {
        margin-top: 20px;
        padding: 15px;
        background-color: #e9f5ff;
        border: 1px solid #b3d7ff;
        border-radius: 4px;
      }
      #results p {
        margin: 8px 0;
        font-size: 1.1em;
      }
      #results p strong {
        color: #0056b3;
      }
      small {
        color: #666;
      }
      #prepaymentSection {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        margin-top: 10px;
      }
      #prepaymentResults {
        background-color: #e8f5e8;
        border: 1px solid #c3e6cb;
      }
      #prepaymentResults h3 {
        color: #155724;
        margin-top: 0;
      }
      input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.2);
      }
      .checkbox-label {
        display: flex;
        align-items: center;
        font-weight: bold;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ°å®¶çš„å…¬ç§¯é‡‘è´·æ¬¾è®¡ç®—å™¨</h1>
      <p style="text-align: center; color: #555">
        è‡ªç”±è®¾å®šè´·æ¬¾å¹´é™ï¼Œæ”¯æŒæå‰è¿˜æ¬¾è®¡ç®—ï¼Œç²¾å‡†è§„åˆ’æ‚¨çš„è¿˜æ¬¾æ–¹æ¡ˆã€‚
      </p>

      <div class="form-group">
        <label for="loanAmount">è´·æ¬¾æ€»é¢ (å…ƒ):</label>
        <input type="number" id="loanAmount" placeholder="ä¾‹å¦‚: 1000000" />
      </div>

      <div class="form-group">
        <label for="loanTerm">è´·æ¬¾å¹´é™ (1-30å¹´):</label>
        <input
          type="number"
          id="loanTerm"
          value="30"
          min="1"
          max="30"
          oninput="updateInterestRate()"
        />
        <small>è¯·è¾“å…¥1è‡³30ä¹‹é—´çš„æ•´æ•°å¹´é™ã€‚</small>
      </div>

      <div class="form-group">
        <label for="interestRate">è´·æ¬¾å¹´åˆ©ç‡ (%):</label>
        <input
          type="number"
          id="interestRate"
          step="0.001"
          placeholder="è¯·å¡«å†™å¹´åˆ©ç‡"
        />
        <small
          >æç¤ºï¼šè®¡ç®—å™¨ä¼šæ ¹æ®å¹´é™è‡ªåŠ¨å¡«å……é¦–å¥—æˆ¿å»ºè®®åˆ©ç‡ï¼Œå¯è‡ªè¡Œä¿®æ”¹ã€‚</small
        >
      </div>

      <div class="form-group">
        <label for="repaymentMethod">è¿˜æ¬¾æ–¹å¼:</label>
        <select id="repaymentMethod">
          <option value="equal-installments">ç­‰é¢æœ¬æ¯</option>
          <option value="equal-principal">ç­‰é¢æœ¬é‡‘</option>
        </select>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input
            type="checkbox"
            id="enablePrepayment"
            onchange="togglePrepayment()"
          />
          è®¡ç®—æå‰è¿˜æ¬¾
        </label>
      </div>

      <div id="prepaymentSection" style="display: none">
        <div class="form-group">
          <label for="prepaymentMonth">ç¬¬å‡ ä¸ªæœˆæå‰è¿˜æ¬¾:</label>
          <input
            type="number"
            id="prepaymentMonth"
            min="1"
            placeholder="ä¾‹å¦‚: 24 (ç¬¬24ä¸ªæœˆ)"
          />
          <small>è¯·è¾“å…¥åœ¨ç¬¬å‡ ä¸ªæœˆè¿›è¡Œæå‰è¿˜æ¬¾ã€‚</small>
        </div>

        <div class="form-group">
          <label for="prepaymentAmount">æå‰è¿˜æ¬¾é‡‘é¢ (å…ƒ):</label>
          <input
            type="number"
            id="prepaymentAmount"
            placeholder="ä¾‹å¦‚: 100000"
          />
          <small>è¯·è¾“å…¥æå‰è¿˜æ¬¾çš„é‡‘é¢ã€‚</small>
        </div>

        <div class="form-group">
          <label for="prepaymentType">æå‰è¿˜æ¬¾æ–¹å¼:</label>
          <select id="prepaymentType">
            <option value="reduce-term">ç¼©çŸ­è¿˜æ¬¾æœŸé™</option>
            <option value="reduce-payment">å‡å°‘æœˆä¾›é‡‘é¢</option>
          </select>
        </div>
      </div>

      <button onclick="calculate()">å¼€å§‹è®¡ç®—</button>

      <div id="results">
        <h2>è®¡ç®—ç»“æœ</h2>
        <div id="originalResults">
          <h3>åŸå§‹è´·æ¬¾è®¡åˆ’</h3>
          <p><strong>æ¯æœˆæœˆä¾›:</strong> <span id="monthlyPayment">-</span></p>
          <p><strong>åˆ©æ¯æ€»é¢:</strong> <span id="totalInterest">-</span></p>
          <p><strong>è¿˜æ¬¾æ€»é¢:</strong> <span id="totalRepayment">-</span></p>
        </div>

        <div id="prepaymentResults" style="display: none">
          <h3>æå‰è¿˜æ¬¾å</h3>
          <p>
            <strong>æå‰è¿˜æ¬¾æ—¶å‰©ä½™æœ¬é‡‘:</strong>
            <span id="remainingPrincipal">-</span>
          </p>
          <p>
            <strong>æå‰è¿˜æ¬¾åæ–°æœˆä¾›:</strong>
            <span id="newMonthlyPayment">-</span>
          </p>
          <p>
            <strong>å‰©ä½™è¿˜æ¬¾æœŸæ•°:</strong> <span id="remainingMonths">-</span>
          </p>
          <p>
            <strong>èŠ‚çœåˆ©æ¯æ€»é¢:</strong> <span id="savedInterest">-</span>
          </p>
          <p>
            <strong>æå‰è¿˜æ¬¾åæ€»è¿˜æ¬¾é¢:</strong>
            <span id="newTotalRepayment">-</span>
          </p>
        </div>
      </div>
    </div>

    <script>
      function togglePrepayment() {
        const checkbox = document.getElementById("enablePrepayment");
        const section = document.getElementById("prepaymentSection");
        const results = document.getElementById("prepaymentResults");

        if (checkbox.checked) {
          section.style.display = "block";
        } else {
          section.style.display = "none";
          results.style.display = "none";
        }
      }

      function updateInterestRate() {
        const loanTermInput = document.getElementById("loanTerm");
        const interestRateInput = document.getElementById("interestRate");
        let years = parseInt(loanTermInput.value, 10);

        if (isNaN(years)) {
          interestRateInput.value = "";
          return;
        }

        // é™åˆ¶è¾“å…¥èŒƒå›´
        if (years > 30) loanTermInput.value = 30;
        if (years < 1 && loanTermInput.value !== "") loanTermInput.value = 1;
        years = parseInt(loanTermInput.value, 10);

        if (years > 0 && years <= 5) {
          interestRateInput.value = 2.1;
        } else if (years > 5) {
          interestRateInput.value = 2.6;
        } else {
          interestRateInput.value = "";
        }
      }

      function calculate() {
        const principal = parseFloat(
          document.getElementById("loanAmount").value
        );
        const annualRate = parseFloat(
          document.getElementById("interestRate").value
        );
        const years = parseInt(document.getElementById("loanTerm").value);
        const method = document.getElementById("repaymentMethod").value;
        const enablePrepayment =
          document.getElementById("enablePrepayment").checked;

        if (
          isNaN(principal) ||
          isNaN(annualRate) ||
          isNaN(years) ||
          principal <= 0 ||
          annualRate <= 0 ||
          years <= 0
        ) {
          alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è´·æ¬¾é‡‘é¢ã€åˆ©ç‡å’Œå¹´é™ã€‚");
          return;
        }

        const monthlyRate = annualRate / 100 / 12;
        const months = years * 12;

        // è®¡ç®—åŸå§‹è´·æ¬¾æ–¹æ¡ˆ
        const originalLoan = calculateOriginalLoan(
          principal,
          monthlyRate,
          months,
          method
        );
        displayOriginalResults(originalLoan);

        // å¦‚æœå¯ç”¨æå‰è¿˜æ¬¾ï¼Œè®¡ç®—æå‰è¿˜æ¬¾æ–¹æ¡ˆ
        if (enablePrepayment) {
          const prepaymentMonth = parseInt(
            document.getElementById("prepaymentMonth").value
          );
          const prepaymentAmount = parseFloat(
            document.getElementById("prepaymentAmount").value
          );
          const prepaymentType =
            document.getElementById("prepaymentType").value;

          if (
            isNaN(prepaymentMonth) ||
            isNaN(prepaymentAmount) ||
            prepaymentMonth <= 0 ||
            prepaymentAmount <= 0 ||
            prepaymentMonth >= months
          ) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æå‰è¿˜æ¬¾æœˆä»½å’Œé‡‘é¢ã€‚");
            return;
          }

          const prepaymentResult = calculatePrepayment(
            principal,
            monthlyRate,
            months,
            method,
            prepaymentMonth,
            prepaymentAmount,
            prepaymentType,
            originalLoan
          );

          displayPrepaymentResults(prepaymentResult);
        }
      }

      function calculateOriginalLoan(principal, monthlyRate, months, method) {
        let monthlyPayment, totalInterest, totalRepayment;

        if (method === "equal-installments") {
          const power = Math.pow(1 + monthlyRate, months);
          monthlyPayment = (principal * (monthlyRate * power)) / (power - 1);
          totalRepayment = monthlyPayment * months;
          totalInterest = totalRepayment - principal;
        } else {
          // equal-principal
          let firstMonthPayment = principal / months + principal * monthlyRate;
          const monthlyDecrease = (principal / months) * monthlyRate;
          totalInterest = ((months + 1) * principal * monthlyRate) / 2;
          totalRepayment = principal + totalInterest;
          monthlyPayment = firstMonthPayment; // ç”¨äºæ˜¾ç¤º
        }

        return {
          monthlyPayment,
          totalInterest,
          totalRepayment,
          method,
        };
      }

      function calculatePrepayment(
        principal,
        monthlyRate,
        totalMonths,
        method,
        prepaymentMonth,
        prepaymentAmount,
        prepaymentType,
        originalLoan
      ) {
        // è®¡ç®—æå‰è¿˜æ¬¾æ—¶çš„å‰©ä½™æœ¬é‡‘
        let remainingPrincipal = calculateRemainingPrincipal(
          principal,
          monthlyRate,
          totalMonths,
          method,
          prepaymentMonth
        );

        // æ£€æŸ¥æå‰è¿˜æ¬¾é‡‘é¢æ˜¯å¦è¶…è¿‡å‰©ä½™æœ¬é‡‘
        if (prepaymentAmount >= remainingPrincipal) {
          alert("æå‰è¿˜æ¬¾é‡‘é¢ä¸èƒ½è¶…è¿‡å‰©ä½™æœ¬é‡‘ï¼");
          return null;
        }

        // æå‰è¿˜æ¬¾åçš„æ–°æœ¬é‡‘
        const newPrincipal = remainingPrincipal - prepaymentAmount;
        const remainingMonths = totalMonths - prepaymentMonth;

        let newMonthlyPayment;
        let finalRemainingMonths = remainingMonths;

        if (prepaymentType === "reduce-term") {
          // ä¿æŒæœˆä¾›ä¸å˜ï¼Œç¼©çŸ­æœŸé™
          newMonthlyPayment = originalLoan.monthlyPayment;
          if (method === "equal-installments") {
            // è®¡ç®—æ–°çš„è¿˜æ¬¾æœŸæ•°
            finalRemainingMonths = Math.ceil(
              Math.log(1 + (newPrincipal * monthlyRate) / newMonthlyPayment) /
                Math.log(1 + monthlyRate)
            );
          } else {
            // ç­‰é¢æœ¬é‡‘ï¼Œé‡æ–°è®¡ç®—æœŸæ•°
            finalRemainingMonths = Math.ceil(
              newPrincipal / (newMonthlyPayment - newPrincipal * monthlyRate)
            );
          }
        } else {
          // ä¿æŒæœŸé™ä¸å˜ï¼Œå‡å°‘æœˆä¾›
          if (method === "equal-installments") {
            const power = Math.pow(1 + monthlyRate, remainingMonths);
            newMonthlyPayment =
              (newPrincipal * (monthlyRate * power)) / (power - 1);
          } else {
            // ç­‰é¢æœ¬é‡‘ï¼Œé‡æ–°è®¡ç®—é¦–æœˆæœˆä¾›
            newMonthlyPayment =
              newPrincipal / remainingMonths + newPrincipal * monthlyRate;
          }
        }

        // è®¡ç®—èŠ‚çœçš„åˆ©æ¯
        const originalRemainingInterest = calculateRemainingInterest(
          principal,
          monthlyRate,
          totalMonths,
          method,
          prepaymentMonth
        );

        const newTotalInterest = calculateNewTotalInterest(
          newPrincipal,
          monthlyRate,
          finalRemainingMonths,
          method
        );

        const savedInterest = originalRemainingInterest - newTotalInterest;

        // è®¡ç®—æ–°çš„æ€»è¿˜æ¬¾é¢ï¼ˆåŒ…æ‹¬å·²è¿˜çš„+æå‰è¿˜æ¬¾+å‰©ä½™è¿˜æ¬¾ï¼‰
        const paidAmount = calculatePaidAmount(
          principal,
          monthlyRate,
          totalMonths,
          method,
          prepaymentMonth
        );
        const newTotalRepayment =
          paidAmount + prepaymentAmount + newTotalInterest + newPrincipal;

        return {
          remainingPrincipal,
          newMonthlyPayment,
          remainingMonths: finalRemainingMonths,
          savedInterest,
          newTotalRepayment,
          method,
        };
      }

      function calculateRemainingPrincipal(
        principal,
        monthlyRate,
        totalMonths,
        method,
        currentMonth
      ) {
        if (method === "equal-installments") {
          const power = Math.pow(1 + monthlyRate, totalMonths);
          const monthlyPayment =
            (principal * (monthlyRate * power)) / (power - 1);

          let remainingPrincipal = principal;
          for (let i = 1; i <= currentMonth; i++) {
            const interestPayment = remainingPrincipal * monthlyRate;
            const principalPayment = monthlyPayment - interestPayment;
            remainingPrincipal -= principalPayment;
          }
          return remainingPrincipal;
        } else {
          // ç­‰é¢æœ¬é‡‘
          const monthlyPrincipal = principal / totalMonths;
          return principal - monthlyPrincipal * currentMonth;
        }
      }

      function calculateRemainingInterest(
        principal,
        monthlyRate,
        totalMonths,
        method,
        currentMonth
      ) {
        if (method === "equal-installments") {
          const power = Math.pow(1 + monthlyRate, totalMonths);
          const monthlyPayment =
            (principal * (monthlyRate * power)) / (power - 1);
          const totalRepayment = monthlyPayment * totalMonths;
          const totalInterest = totalRepayment - principal;

          // è®¡ç®—å·²æ”¯ä»˜åˆ©æ¯
          let paidInterest = 0;
          let remainingPrincipal = principal;
          for (let i = 1; i <= currentMonth; i++) {
            const interestPayment = remainingPrincipal * monthlyRate;
            paidInterest += interestPayment;
            const principalPayment = monthlyPayment - interestPayment;
            remainingPrincipal -= principalPayment;
          }

          return totalInterest - paidInterest;
        } else {
          // ç­‰é¢æœ¬é‡‘å‰©ä½™åˆ©æ¯è®¡ç®—
          const monthlyPrincipal = principal / totalMonths;
          let remainingInterest = 0;

          for (let i = currentMonth + 1; i <= totalMonths; i++) {
            const currentPrincipal = principal - monthlyPrincipal * (i - 1);
            remainingInterest += currentPrincipal * monthlyRate;
          }

          return remainingInterest;
        }
      }

      function calculateNewTotalInterest(
        principal,
        monthlyRate,
        months,
        method
      ) {
        if (method === "equal-installments") {
          const power = Math.pow(1 + monthlyRate, months);
          const monthlyPayment =
            (principal * (monthlyRate * power)) / (power - 1);
          return monthlyPayment * months - principal;
        } else {
          // ç­‰é¢æœ¬é‡‘
          return ((months + 1) * principal * monthlyRate) / 2;
        }
      }

      function calculatePaidAmount(
        principal,
        monthlyRate,
        totalMonths,
        method,
        currentMonth
      ) {
        if (method === "equal-installments") {
          const power = Math.pow(1 + monthlyRate, totalMonths);
          const monthlyPayment =
            (principal * (monthlyRate * power)) / (power - 1);
          return monthlyPayment * currentMonth;
        } else {
          // ç­‰é¢æœ¬é‡‘
          const monthlyPrincipal = principal / totalMonths;
          let totalPaid = 0;

          for (let i = 1; i <= currentMonth; i++) {
            const currentPrincipal = principal - monthlyPrincipal * (i - 1);
            const monthlyInterest = currentPrincipal * monthlyRate;
            totalPaid += monthlyPrincipal + monthlyInterest;
          }

          return totalPaid;
        }
      }

      function displayOriginalResults(loan) {
        if (loan.method === "equal-installments") {
          document.getElementById("monthlyPayment").innerText =
            loan.monthlyPayment.toFixed(2) + " å…ƒ";
        } else {
          const monthlyDecrease =
            (document.getElementById("loanAmount").value /
              (document.getElementById("loanTerm").value * 12)) *
            (document.getElementById("interestRate").value / 100 / 12);
          document.getElementById(
            "monthlyPayment"
          ).innerHTML = `é¦–æœˆ ${loan.monthlyPayment.toFixed(
            2
          )} å…ƒ (æ¯æœˆé€’å‡çº¦ ${monthlyDecrease.toFixed(2)} å…ƒ)`;
        }

        document.getElementById("totalInterest").innerText =
          loan.totalInterest.toFixed(2) + " å…ƒ";
        document.getElementById("totalRepayment").innerText =
          loan.totalRepayment.toFixed(2) + " å…ƒ";
      }

      function displayPrepaymentResults(result) {
        if (!result) return;

        document.getElementById("prepaymentResults").style.display = "block";
        document.getElementById("remainingPrincipal").innerText =
          result.remainingPrincipal.toFixed(2) + " å…ƒ";

        if (result.method === "equal-installments") {
          document.getElementById("newMonthlyPayment").innerText =
            result.newMonthlyPayment.toFixed(2) + " å…ƒ";
        } else {
          const prepaymentAmount = parseFloat(
            document.getElementById("prepaymentAmount").value
          );
          const newPrincipal = result.remainingPrincipal - prepaymentAmount;
          const monthlyRate =
            parseFloat(document.getElementById("interestRate").value) /
            100 /
            12;
          const monthlyDecrease =
            (newPrincipal / result.remainingMonths) * monthlyRate;
          document.getElementById(
            "newMonthlyPayment"
          ).innerHTML = `é¦–æœˆ ${result.newMonthlyPayment.toFixed(
            2
          )} å…ƒ (æ¯æœˆé€’å‡çº¦ ${monthlyDecrease.toFixed(2)} å…ƒ)`;
        }

        document.getElementById("remainingMonths").innerText =
          result.remainingMonths + " ä¸ªæœˆ";
        document.getElementById("savedInterest").innerText =
          result.savedInterest.toFixed(2) + " å…ƒ";
        document.getElementById("newTotalRepayment").innerText =
          result.newTotalRepayment.toFixed(2) + " å…ƒ";
      }

      // é¡µé¢åŠ è½½æ—¶æ ¹æ®é»˜è®¤å¹´é™ï¼ˆ30å¹´ï¼‰è®¾ç½®é»˜è®¤åˆ©ç‡
      window.onload = updateInterestRate;
    </script>
  </body>
</html>
